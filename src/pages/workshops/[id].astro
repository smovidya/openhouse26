---
import { workshops } from "@src/data/workshops";
import Layout from "@src/layouts/ContentLayout.astro";
import type { GetStaticPaths } from "astro";
import WorkshopSlotSelector from "@src/components/workshop-slot-selector.svelte";
import {
  getUserRegisteredSlots,
  getRegisteredParticipantCount,
} from "@src/db/model/workshop";
import { featureFlags } from "@src/data/constants";

// We still need to load user registration data on the server side
// so we cannot prerender this page.
export const prerender = false;

export const getStaticPaths: GetStaticPaths = () =>
  workshops.map((it) => ({
    params: { id: it.id },
  }));

const { id } = Astro.params;
const workshop = workshops.find((it) => it.id === id)!;

const staging = Astro.locals.runtime.env.ENVIRONMENT === "staging";

if (
  !workshop ||
  (!(import.meta.env.DEV || staging) && !featureFlags.workshopRegistration)
) {
  return Astro.redirect("/404");
}

const selectedWorkshops = Astro.locals.user?.id
  ? await getUserRegisteredSlots(Astro.locals.db, Astro.locals.user?.id)
  : [];
const registeredParticipantCount = await getRegisteredParticipantCount(
  Astro.locals.db,
  String(id),
);
---

<Layout
  title="Workshops"
  description="เวิร์กช็อปสำหรับน้อง ๆ ที่สนใจกิจกรรมของภาควิชาต่าง ๆ"
  image="/og-image.png"
  showNavBar={true}
>
  <a href="/workshops" class="btn btn-ghost">กลับไปรายการเวิร์กช็อป</a>
  <div class="flex flex-col items-center text-center">
    <img
      src="/workshop-pictures/Workshop.png"
      alt="Workshops"
      class="mt-6 w-72"
    />
    <img
      src={workshop.image}
      alt=""
      class="mask mask-hexagon-2 mx-auto mt-6 size-48 object-cover"
    />
  </div>
  <div class="mt-4 flex flex-col text-white">
    <span class="font-serif text-xl text-blue-300">Workshop</span>
    <h1 class="font-serif text-4xl font-bold">{workshop.title}</h1>
    <span class="mt-2 text-lg text-blue-200">{workshop.hostDepartment}</span>
  </div>

  <article class="mt-5 text-sm text-blue-100">
    {workshop.description}
  </article>

  <WorkshopSlotSelector
    workshopId={workshop.id}
    initialSelectedWorkshops={selectedWorkshops}
    initialRegisterCount={registeredParticipantCount}
    client:load
    class="my-8"
  />
</Layout>
