---
import { workshops } from "@src/data/workshops";
import Layout from "@src/layouts/ContentLayout.astro";
import type { GetStaticPaths } from "astro";
import WorkshopSlotSelector from "@src/components/workshop-slot-selector.svelte";
import {
  getUserRegisteredSlots,
  getRegisteredParticipantCount,
} from "@src/db/model/workshop";
import { featureFlags } from "@src/data/constants";
import { getHandler } from "@src/actions/workshop-but-do";
import { getParticipantByUserId } from "@src/db/model/participant";
import type { WorkshopRegistrationHandler2 } from "@src/workers";

// We still need to load user registration data on the server side
// so we cannot prerender this page.
export const prerender = false;

export const getStaticPaths: GetStaticPaths = () =>
  workshops.map((it) => ({
    params: { id: it.id },
  }));

const { id } = Astro.params;
const workshop = workshops.find((it) => it.id === id)!;

const dev =
  import.meta.env.DEV || Astro.locals.runtime.env.ENVIRONMENT === "staging";
if (!workshop || (!dev && !featureFlags.workshopRegistration)) {
  return Astro.redirect("/404");
}

// const selectedWorkshops = Astro.locals.user?.id
//   ? await getUserRegisteredSlots(Astro.locals.db, Astro.locals.user?.id)
//   : [];
// const registeredParticipantCount = await getRegisteredParticipantCount(
//   Astro.locals.db,
//   String(id)
// );

const uid = Astro.locals.user?.id;
if (!uid) {
  return Astro.redirect("/");
}
const participant = (await getParticipantByUserId(Astro.locals.db, uid))!;
console.log(Astro.locals.runtime.env);
const handler =
  Astro.locals.runtime.env.WORKSHOP_REGISTRATION_HANDLER2.getByName(
    "default",
  ) as DurableObjectStub<WorkshopRegistrationHandler2>;
const selectedWorkshops = await handler.getRegistrationsByUser(participant.id);
const registeredParticipantCount = await handler.getRegistrationCount(
  workshop.id,
);

const initialRegisterCount = Object.entries(registeredParticipantCount).map(
  (it) => ({
    roundNumber: parseInt(it[0]),
    count: parseInt(it[1]),
  }),
);
---

<Layout
  title="Workshops"
  description="เวิร์กช็อปสำหรับน้อง ๆ ที่สนใจกิจกรรมของภาควิชาต่าง ๆ"
  image="/og-image.png"
  showNavBar={true}
>
  <div class="flex flex-col items-center text-center">
    <img
      src="/workshop-pictures/Workshop.png"
      alt="Workshops"
      class="w-72 mt-6"
    />
    <img
      src={workshop.image}
      alt=""
      class="mask mask-hexagon-2 size-48 object-cover mx-auto mt-6"
    />
  </div>
  <!-- TODO: image? -->
  <div class="flex flex-col text-white mt-4">
    <span class="text-blue-300 text-xl font-serif">Workshop</span>
    <h1 class="text-4xl font-bold font-serif">{workshop.title}</h1>
    <span class="mt-2 text-blue-200 text-lg">{workshop.hostDepartment}</span>
  </div>

  <article class="mt-5 text-blue-100 text-sm">
    {workshop.description}
  </article>

  <WorkshopSlotSelector
    workshopId={workshop.id}
    initialSelectedWorkshops={selectedWorkshops}
    initialRegisterCount={initialRegisterCount}
    client:load
    class="my-8"
  />
</Layout>
